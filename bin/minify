#!/bin/bash

`[ $# -gt 0 -a "$1" == "--js" ] || [ $# -le 0 ]` && js_only=true || js_only=false
`[ $# -gt 0 -a "$1" == "--css" ] || [ $# -le 0 ]` && css_only=true || css_only=false

js_minifier=compiler.jar
js_bin_dir=../js
js_src_dir=../js/uncompiled

css_minifier="yuicompressor.jar"
css_bin_dir=../css
css_src_dir=../css/uncompiled

function doJsMinify() {
    out=$1; shift
    args=""
    for l in $@; do
        args="--js=$l "$args
    done
    [ -f $out ] && rm -rf $out
    java -jar $js_minifier $args --js_output_file=$out
}

function doCssMinify() {
    out=$1; shift
    [ -f $out ] && rm -rf $out
    java -jar $css_minifier --verbose --type css -o $out $@
}

if $js_only; then
    ## First, we create the libs js
    doJsMinify $js_bin_dir/hg_libs.js \
               $js_src_dir/libtabs.js $js_src_dir/libhttprequest.js $js_src_dir/libpicasaweb.js \
                                      $js_src_dir/libslideshow.js $js_src_dir/libgoogledata.js

    ## Create the js for the other pages
    doJsMinify $js_bin_dir/hg_featurepages.js \
               $js_bin_dir/hg_libs.js `ls -1 $js_src_dir/hg_*.js | grep -v hg_features.js`

    ## Create the js for the main page
    doJsMinify $js_bin_dir/hg_mainpage.js \
               $js_bin_dir/hg_featurepages.js $js_src_dir/hg_features.js

    #for c in `ls -1 $js_src_dir/*.js`; do
        #minified=$js_bin_dir/opt/`basename $c`
        #[ -f $minified ] && rm -rf $minified
        #doJsMinify $minified $c
    #done
fi

## Minify the css libs
if $css_only; then
    for c in `ls -1 $css_src_dir/*.css`; do
        minified=$css_bin_dir/`basename $c`
        [ -f $minified ] && rm -rf $minified
        doCssMinify $minified $c
    done
fi
